---
import BaseLayout from '../layouts/BaseLayout.astro';
import PackageSelector from '../components/PackageSelector.astro';
import CheckoutForm from '../components/CheckoutForm.astro';
import BankInfo from '../components/BankInfo.astro';
import { siteData } from '../data/siteData';

// Get selected package from query params
const paket = Astro.url.searchParams.get('paket') || '';
---

<BaseLayout
  title="Konfirmasi Donasi â€” Yayasan Pondok Pesantren Ulul Ilmi"
  description="Lengkapi data dan konfirmasi donasi Anda untuk santri yatim dan penghafal Al-Qur'an."
>
  <!-- Checkout Navbar -->
  <nav class="bg-white border-b border-[#E5EBE7] sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between">
      <a
        href="/"
        class="flex items-center gap-2 text-sm font-medium text-[#4A5D52] hover:text-[#0F4A2A] transition-colors duration-200"
      >
        <i class="fas fa-arrow-left"></i>
        <span class="hidden sm:inline">Kembali ke Beranda</span>
        <span class="sm:hidden">Kembali</span>
      </a>
      <a href="/" class="flex items-center gap-2">
        <img
          src={siteData.assets.logoUrl}
          alt={`Logo ${siteData.name}`}
          class="h-8 w-auto"
        />
      </a>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="max-w-6xl mx-auto px-4 sm:px-6 py-8 sm:py-12">
    <!-- Page Header -->
    <div class="text-center mb-8 sm:mb-10">
      <div class="inline-flex items-center gap-2 bg-[#F4F7F5] text-[#0F4A2A] text-[11px] font-bold uppercase tracking-widest px-4 py-2 rounded-full mb-4 border border-[#E5EBE7]">
        <i class="fas fa-hand-holding-heart text-[#F59E0B]"></i>
        Konfirmasi Donasi
      </div>
      <h1 class="text-2xl sm:text-[28px] font-bold text-[#0F4A2A] leading-tight tracking-tight">
        Sempurnakan Donasi Anda
      </h1>
      <p class="text-sm sm:text-base text-[#4A5D52] mt-2 max-w-md mx-auto">
        Lengkapi data berikut untuk menyempurnakan donasi Anda bagi santri yatim & penghafal Al-Qur'an
      </p>
    </div>

    <!-- Two-column layout (desktop) / single column (mobile) -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 lg:gap-8 items-start">

      <!-- LEFT COLUMN: Form (3/5 on desktop) -->
      <div class="lg:col-span-3 space-y-6">
        <PackageSelector selectedPackageId={paket} />
        <CheckoutForm />
      </div>

      <!-- RIGHT COLUMN: Payment info + actions (2/5 on desktop) -->
      <div class="lg:col-span-2 space-y-6 lg:sticky lg:top-24">

        <!-- Payment method -->
        <div class="card-luxury" id="payment-method">
          <h3 class="checkout-section-label">Metode Pembayaran</h3>

          <div class="space-y-3">
            <label class="checkout-radio-option checkout-radio-active" id="radio-transfer">
              <input
                type="radio"
                name="metode"
                value="transfer"
                class="checkout-radio-input"
                checked
              />
              <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-lg bg-[#F4F7F5] flex items-center justify-center">
                  <i class="fas fa-university text-[#0F4A2A] text-sm"></i>
                </div>
                <div>
                  <p class="text-sm font-medium text-[#0F4A2A]">Transfer Bank</p>
                  <p class="text-[11px] text-[#9CA3AF]">BSI, BCA, Mandiri, dll.</p>
                </div>
              </div>
              <div class="checkout-radio-dot">
                <div class="checkout-radio-inner"></div>
              </div>
            </label>

            <label class="checkout-radio-option" id="radio-ewallet">
              <input
                type="radio"
                name="metode"
                value="ewallet"
                class="checkout-radio-input"
              />
              <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-lg bg-[#F4F7F5] flex items-center justify-center">
                  <i class="fas fa-qrcode text-[#0D9488] text-sm"></i>
                </div>
                <div>
                  <p class="text-sm font-medium text-[#0F4A2A]">E-Wallet / QRIS</p>
                  <p class="text-[11px] text-[#9CA3AF]">GoPay, OVO, DANA, ShopeePay</p>
                </div>
              </div>
              <div class="checkout-radio-dot">
                <div class="checkout-radio-inner"></div>
              </div>
            </label>
          </div>
        </div>

        <!-- Bank Info -->
        <BankInfo />

        <!-- Action Buttons -->
        <div class="space-y-3">
          <button
            type="button"
            id="btn-konfirmasi"
            class="btn-primary w-full gap-2 text-sm"
          >
            <i class="fab fa-whatsapp text-base"></i>
            Konfirmasi Transfer
          </button>

          <button
            type="button"
            id="btn-kunjungan"
            class="btn-secondary w-full gap-2 text-sm"
          >
            <i class="fas fa-mosque text-base"></i>
            Jadwalkan Kunjungan
          </button>
        </div>

        <!-- Trust badge -->
        <div class="flex items-start gap-2 px-1">
          <i class="fas fa-shield-alt text-[#10B981] text-sm mt-0.5"></i>
          <p class="text-[11px] text-[#9CA3AF] leading-relaxed">
            Informasi Anda aman dan hanya digunakan untuk koordinasi donasi.
            Data tidak akan dibagikan kepada pihak ketiga.
          </p>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer mini -->
  <footer class="border-t border-[#E5EBE7] mt-12 py-6 text-center">
    <p class="text-[11px] text-[#9CA3AF]">
      &copy; 2026 {siteData.fullName}. Semua hak dilindungi.
    </p>
  </footer>
</BaseLayout>

<script>
  import { packages } from '../data/packages';
  import { siteData } from '../data/siteData';

  document.addEventListener('DOMContentLoaded', () => {
    const btnKonfirmasi = document.getElementById('btn-konfirmasi')!;
    const btnKunjungan = document.getElementById('btn-kunjungan')!;
    const radioTransfer = document.getElementById('radio-transfer')!;
    const radioEwallet = document.getElementById('radio-ewallet')!;

    // Radio styling
    document.querySelectorAll('input[name="metode"]').forEach((radio) => {
      radio.addEventListener('change', (e) => {
        document.querySelectorAll('.checkout-radio-option').forEach(el => {
          el.classList.remove('checkout-radio-active');
        });
        const target = e.target as HTMLInputElement;
        target.closest('.checkout-radio-option')?.classList.add('checkout-radio-active');
      });
    });

    // Gather form data helper
    function getFormData() {
      const paketSelect = document.getElementById('paket') as HTMLSelectElement;
      const selectedPkg = packages.find(p => p.id === paketSelect.value);
      const subitemSelect = document.getElementById('subitem') as HTMLSelectElement;
      const qty = parseInt((document.getElementById('qty') as HTMLInputElement).value) || 1;
      const nama = (document.getElementById('nama') as HTMLInputElement).value;
      const telp = (document.getElementById('telp') as HTMLInputElement).value;
      const catatan = (document.getElementById('catatan') as HTMLTextAreaElement).value;
      const metode = (document.querySelector('input[name="metode"]:checked') as HTMLInputElement)?.value || 'transfer';
      const totalEl = document.getElementById('total-price')!;

      let varianText = '';
      if (selectedPkg?.subItems && subitemSelect && subitemSelect.value !== '') {
        const idx = parseInt(subitemSelect.value);
        varianText = selectedPkg.subItems[idx]?.label || '';
      }

      return {
        paketTitle: selectedPkg?.title || '',
        varian: varianText,
        qty,
        total: totalEl.textContent || 'Rp0',
        nama: nama || 'Hamba Allah',
        telp,
        catatan,
        metode: metode === 'transfer' ? 'Transfer Bank' : 'E-Wallet / QRIS',
      };
    }

    // Validate form
    function validateForm(): boolean {
      const nama = document.getElementById('nama') as HTMLInputElement;
      const telp = document.getElementById('telp') as HTMLInputElement;
      const anonim = document.getElementById('anonim') as HTMLInputElement;

      let valid = true;

      if (!anonim.checked && nama.value.length < 3) {
        nama.classList.add('!border-[#E11D48]');
        document.getElementById('nama-error')?.classList.remove('hidden');
        valid = false;
      }

      if (!/^08[0-9]{8,12}$/.test(telp.value)) {
        telp.classList.add('!border-[#E11D48]');
        document.getElementById('telp-error')?.classList.remove('hidden');
        valid = false;
      }

      return valid;
    }

    // Generate WhatsApp URL
    function generateWhatsAppUrl(type: 'konfirmasi' | 'kunjungan'): string {
      const data = getFormData();
      const phone = siteData.contact.phone.replace(/\D/g, '');
      const phoneInternational = '62' + phone.slice(1);

      let message = '';

      if (type === 'konfirmasi') {
        message = `Assalamu'alaikum, saya ingin mengkonfirmasi donasi:\n\n`;
        message += `ðŸ“‹ Paket: ${data.paketTitle}`;
        if (data.varian) message += ` (${data.varian})`;
        message += `\nðŸ’° Jumlah: ${data.qty} Ã— = ${data.total}`;
        message += `\nðŸ‘¤ Nama: ${data.nama}`;
        message += `\nðŸ“± No. WA: ${data.telp}`;
        message += `\nðŸ’³ Metode: ${data.metode}`;
        if (data.catatan) message += `\nðŸ“ Catatan: ${data.catatan}`;
        message += `\n\nMohon dikonfirmasi. Jazakumullahu khairan. ðŸ™`;
      } else {
        message = `Assalamu'alaikum, saya ingin menjadwalkan kunjungan ke pesantren:\n\n`;
        message += `ðŸ‘¤ Nama: ${data.nama}`;
        message += `\nðŸ“± No. WA: ${data.telp}`;
        message += `\nðŸ“‹ Terkait Paket: ${data.paketTitle}`;
        if (data.catatan) message += `\nðŸ“ Catatan: ${data.catatan}`;
        message += `\n\nMohon diinformasikan jadwal yang tersedia. Jazakumullahu khairan. ðŸ™`;
      }

      return `https://wa.me/${phoneInternational}?text=${encodeURIComponent(message)}`;
    }

    // Button handlers
    btnKonfirmasi.addEventListener('click', () => {
      if (!validateForm()) return;
      window.open(generateWhatsAppUrl('konfirmasi'), '_blank');
    });

    btnKunjungan.addEventListener('click', () => {
      if (!validateForm()) return;
      window.open(generateWhatsAppUrl('kunjungan'), '_blank');
    });
  });
</script>
